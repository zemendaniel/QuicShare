name: Build Windows Installers & Release

on:
  push:
    tags:
      - 'v*'  # Trigger on tags like v1.0, v1.1, etc.

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: Determine version
        id: set_version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match 'refs/tags/(.+)') {
              $ver = $Matches[1]
          } else {
              $ver = git describe --tags --always
          }
          # Remove leading 'v' if present
          $ver = $ver -replace '^v', ''
          echo "version=$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8
      
      - name: Create artifacts folder
        run: mkdir "$env:GITHUB_WORKSPACE\artifacts"

      # -------------------------
      # Windows x64
      # -------------------------
      - name: Publish Windows x64
        run: |
          dotnet publish .\QuicFileSharing.GUI\QuicFileSharing.GUI.csproj -c Release -r win-x64 --self-contained true /p:UseAppHost=true /p:Version=${{ steps.set_version.outputs.version }}
          echo "PUBLISH_DIR_X64=$env:GITHUB_WORKSPACE\QuicFileSharing.GUI\bin\Release\net9.0\win-x64\publish" >> $GITHUB_ENV

      - name: Generate vars.iss for x64
        shell: pwsh
        run: |
          $ver = '${{ steps.set_version.outputs.version }}'
          @"
          #define PublishDir = "..\QuicFileSharing.GUI\bin\Release\net9.0\win-x64\publish"
          #define AppVersion = "$ver"
          "@ | Set-Content "$env:GITHUB_WORKSPACE\installer\vars.iss" -Encoding utf8
      
      
      - name: Build x64 installer
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            "$env:GITHUB_WORKSPACE\installer\QuicShareInstaller.iss" `
            /O"$env:GITHUB_WORKSPACE\artifacts" `
            /F"QuicShareInstaller-v${{ steps.set_version.outputs.version }}-win-x64"

      # -------------------------
      # Windows ARM64
      # -------------------------
      - name: Publish Windows ARM64
        run: |
          dotnet publish .\QuicFileSharing.GUI\QuicFileSharing.GUI.csproj -c Release -r win-arm64 --self-contained true /p:UseAppHost=true /p:Version=${{ steps.set_version.outputs.version }}
          echo "PUBLISH_DIR_ARM64=$env:GITHUB_WORKSPACE\QuicFileSharing.GUI\bin\Release\net9.0\win-arm64\publish" >> $GITHUB_ENV

      - name: Generate vars.iss for ARM64
        shell: pwsh
        run: |
          $ver = '${{ steps.set_version.outputs.version }}'
          @"
          #define PublishDir = "..\QuicFileSharing.GUI\bin\Release\net9.0\win-arm64\publish"
          #define AppVersion = "$ver"
          "@ | Set-Content "$env:GITHUB_WORKSPACE\installer\vars.iss" -Encoding utf8
      
      - name: Build ARM64 installer
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" `
            "$env:GITHUB_WORKSPACE\installer\QuicShareInstaller.iss" `
            /O"$env:GITHUB_WORKSPACE\artifacts" `
            /F"QuicShareInstaller-v${{ steps.set_version.outputs.version }}-win-arm64"

      - name: Upload Binaries to QuicShare Server
        shell: bash
        run: |
          VERSION="${{ github.ref_name }}"
          WIN_X64="artifacts/QuicShareInstaller-${VERSION}-win-x64.exe"
          WIN_ARM64="artifacts/QuicShareInstaller-${VERSION}-win-arm64.exe"

          echo "Uploading $WIN_X64 and $WIN_ARM64 to server..."

          # We use the exact same endpoint and secrets as the Linux workflow
          curl -X POST "${{ secrets.SERVER_URL }}/api/admin/upload-release" \
            -H "Authorization: Bearer ${{ secrets.ADMIN_API_KEY }}" \
            -F "version=$VERSION" \
            -F "win_x64=@$WIN_X64" \
            -F "win_arm64=@$WIN_ARM64" \
            --fail --show-error
